Сервис Auth API предназначен для аутентификации пользователей. Сервис управляет списком пользователей. Пользователь может быть простым или администратором. Посредством API можно создать только простого пользователя. Создать администратора можно из командной строки.

Сервис Auth API реализует механизм управления ролями пользователей. Пользователь может иметь до нескольких ролей. Auth API выполняет только аутентификацию и предоставляет механизм управления ролями. Авторизацию (ограничение доступа к контенту в соответствии с ролями) реализует прикладной сервис - Async API, Frontend... Возможные роли - `subscriber`, `trial`, `adult`…

Управлять ролями может только администратор. Пароль администратора выдается только доверенному сервису. Это позволяет ограничить риски несанкционированного использования сервиса при условии свободного доступа к API.

Access токен реализован в формате JWT. Refresh токен реализован в виде UUID и хранится в Postgres. Это позволяет реализовать выход на всех устройствах. Также, при обновлении refresh токена в payload access токена обновляется информация о пользователе (список ролей).

Доступ к PostgreSQL осуществляется с помощью библиотеки [Flask SQLAlchemy](https://flask-sqlalchemy.palletsprojects.com/en/3.0.x/). Для управления структурой базы используется [Flask-Migrate](https://flask-migrate.readthedocs.io/en/latest/).

Основные команды Flask-Migrate:
`flask db init` - начальная инициализация пакета, выполняется один раз.
После изменения моделей необходимо создать файл с описанием миграции командой `flask db migrate`.
Файл создается в папке `auth/migrations/versions`. Его надо просмотреть и поправить вручную. Выполнение миграции в базе данных запускается командой `flask db upgrade`.

[ER-диаграмма PostgreSQL](auth-er-diagram.md)

[Описание API в формате OpenAPI](auth-openapi.yaml)

# Последовательность запросов при различных действиях

[Регистрация нового пользователя](sd-signup.md)

[Вход пользователя](sd-login.md)

[Обновление токенов](sd-refresh.md)

[Проверка пользователя](sd-check.md)

[Удаление пользователя](sd-delete.md)
